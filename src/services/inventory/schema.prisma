datasource db {
    provider = "mysql"
    url      = "mysql://root:password@localhost:3306/inventory"
}

generator db {
    provider = "go run github.com/steebchen/prisma-client-go"
}

// Represents a cluster 
model Cluster {
    Id Int @id @default(autoincrement()) @map("ID")
    Name String @map("TX_NAME")
    Description String @map("TX_DESCRIPTION")
    Host String @map("TX_HOST")
    Port Int @map("NM_PORT")
    User String @map("TX_USER")
    Password String @map("TX_PASSWORD")

    UpdatedAt DateTime @updatedAt @map("DT_UPDATED_AT")
    CreatedAt DateTime @default(now()) @map("DT_CREATED_AT")
    DeletedAt DateTime? @map("DT_DELETED_AT")

    Users User[]
    VirtualHosts VirtualHost[]
    Queues Queue[]
    Exchanges Exchange[] 

    @@unique([Host, Port],name: "UNIQUE_NAME_HOST_PORT")
    @@map("TB_CLUSTER")
}


// Represents a virtual host in RabbitMQ
model VirtualHost {
    Id Int @id @default(autoincrement())
    Name String @map("TX_NAME") 
    Description String @map("TX_DESCRIPTION")
    DefaultQueueType QueueType @map("TY_DEFAULT_QUEUE_TYPE")
    Tags Json @map("JS_TAGS")


    ClusterId Int @map("FK_CLUSTER_ID")
    Cluster Cluster @relation(fields: [ClusterId], references: [Id],onDelete: Cascade)

    Lockers LockerVirtualHost[]
    Queues Queue[]
    Exchanges Exchange[]
    BindingExchangeToExchanges BindingExchangeToExchange[]
    BindingExchangeToQueue BindingExchangeToQueue[]

    @@unique([Name, ClusterId],name: "UNIQUE_NAME_CLUSTERID")
    @@map("TB_VIRTUALHOST")
}

// Represents the type of a queue
enum QueueType {
    classic
    quorum
    stream
    undefined
}

// Represents a queue in RabbitMQ
model Queue {
    Id Int @id @default(autoincrement()) @map("ID")
    Name String @map("TX_NAME") @unique()
    Description String @map("TX_DESCRIPTION")
    Durable Boolean @map("IS_DURABLE")
    Arguments Json @map("JS_ARGUMENTS")
    Type QueueType @map("TY_QUEUE_TYPE")

    ClusterId Int @map("FK_CLUSTER_ID")
    Cluster Cluster @relation(fields: [ClusterId], references: [Id],onDelete: Cascade)
    VirtualHostId Int @map("FK_VIRTUALHOST_ID")
    VirtualHost VirtualHost @relation(fields: [VirtualHostId], references: [Id],onDelete: Cascade)

    UpdatedAt DateTime @updatedAt @map("DT_UPDATED_AT")
    CreatedAt DateTime @default(now()) @map("DT_CREATED_AT")
    DeletedAt DateTime? @map("DT_DELETED_AT")

    LockerQueues LockerQueue[]

    ExchangeToQueueBindingsDestination BindingExchangeToQueue[] @relation("exchange-to-queue-destination")


    @@unique([Name,VirtualHostId],name: "UNIQUE_NAME_VIRTUALHOSTID")
    @@unique([Name, ClusterId],name: "UNIQUE_NAME_CLUSTERID")
    @@map("TB_QUEUE")
}

// Represents a user in RabbitMQ
model User {
    Id      Int     @id @default(autoincrement()) @map("ID")
    Username String  @unique @map("TX_USERNAME")
    PasswordHash String @map("TX_PASSWORD_HASH")
    ClusterId Int @map("FK_CLUSTER_ID")
    Cluster Cluster @relation(fields: [ClusterId], references: [Id],onDelete: Cascade)
    

    UpdatedAt DateTime @updatedAt @map("DT_UPDATED_AT")
    CreatedAt DateTime @default(now()) @map("DT_CREATED_AT")
    DeletedAt DateTime? @map("DT_DELETED_AT")

    LockerUser LockerUser[]

    @@map("TB_USER")
    @@unique([Username, ClusterId],name: "UNIQUE_USERNAME_CLUSTERID")
    @@unique([Id, ClusterId],name: "UNIQUE_ID_CLUSTERID")
}

// Represents a exchange in RabbitMQ
model Exchange {
    Id Int @id @default(autoincrement()) @map("ID")

    ClusterId Int @map("FK_CLUSTER_ID")
    Cluster Cluster @relation(fields: [ClusterId], references: [Id],onDelete: Cascade)
    VirtualHostId Int @map("FK_VIRTUALHOST_ID")
    VirtualHost VirtualHost @relation(fields: [VirtualHostId], references: [Id],onDelete: Cascade)
    Name String @map("TX_NAME")  @unique
    Internal Boolean @map("IS_INTERNAL")
    Durable Boolean @map("IS_DURABLE")
    Arguments Json @map("JS_ARGUMENTS")
    Lockers LockerExchange[]
    Type String @map("TX__TYPE")

    ExchangeToExchangeBindingsSources BindingExchangeToExchange[] @relation("exchange-source")
    ExchangeToExchangeBindingsDestination BindingExchangeToExchange[] @relation("exchange-destionation")

    ExchangeToQueueBindingsSources BindingExchangeToQueue[] @relation("exchange-to-queue-source")

    @@unique([ClusterId, Name],name: "UNIQUE_CLUSTERID_NAME")
    @@map("TB_EXCHANGE")

}



// Block a specific exchange for prevent any changes
model LockerExchange {
    Id Int @id @default(autoincrement()) @map("ID")

    ExchangeId Int @map("FK_EXCHANGE_ID")
    Exchange Exchange @relation(fields: [ExchangeId], references: [Id],onDelete: Cascade)

    Enabled Boolean @map("IS_ENABLED")
    Reason String @map("TX_REASON")

    CreatedAt DateTime @default(now()) @map("DT_CREATED_AT")
    UpdatedAt DateTime @updatedAt @map("DT_UPDATED_AT")
    UserResponsibleEmail String @map("TX_USER_RESPONSIBLE_EMAIL")
    UserDisabled String? @map("TX_USER_DISABLED")
}

// Block a specific queue for prevent any changes
model LockerQueue {
    Id Int @id @default(autoincrement()) @map("ID")

    QueueId Int @map("FK_QUEUE_ID")
    Queue Queue @relation(fields: [QueueId], references: [Id],onDelete: Cascade)

    Enabled Boolean @map("IS_ENABLED")
    Reason String @map("TX_REASON")

    CreatedAt DateTime @default(now()) @map("DT_CREATED_AT")
    UpdatedAt DateTime @updatedAt @map("DT_UPDATED_AT")
    UserResponsibleEmail String @map("TX_USER_RESPONSIBLE_EMAIL")
    UserDisabled String? @map("TX_USER_DISABLED")


    @@map("TB_LOCKER_QUEUE")
}

// Block a specific user for prevent any changes
model LockerUser {
    Id Int @id @default(autoincrement()) @map("ID")

    UserId Int @map("FK_USER_ID")
    User User @relation(fields: [UserId], references: [Id],onDelete: Cascade)

    Enabled Boolean @map("IS_ENABLED")
    Reason String @map("TX_REASON")

    CreatedAt DateTime @default(now()) @map("DT_CREATED_AT")
    UpdatedAt DateTime @updatedAt @map("DT_UPDATED_AT")
    UserResponsibleEmail String @map("TX_USER_RESPONSIBLE_EMAIL")
    UserDisabled String? @map("TX_USER_DISABLED")


    @@map("TB_LOCKER_USER")
}

// Block a specific virtual host for prevent any changes
model LockerVirtualHost {
    Id Int @id @default(autoincrement()) @map("ID")
    VirtualHostId Int @map("FK_VIRTUALHOST_ID")
    VirtualHost VirtualHost @relation(fields: [VirtualHostId], references: [Id],onDelete: Cascade)

    Enabled Boolean @map("IS_ENABLED")
    Reason String @map("TX_REASON")
    UserResponsibleEmail String @map("TX_USER_RESPONSIBLE_EMAIL")
    UserDisabled String? @map("TX_USER_DISABLED")
}

model BindingExchangeToQueue {
    Id Int @id @default(autoincrement()) @map("ID")

    VirtualHostId Int @map("FK_VIRTUALHOST_ID")
    VirtualHost VirtualHost @relation(fields: [VirtualHostId], references: [Id],onDelete: Cascade)

    SourceExchangeId Int @map("FK_SOURCE_EXCHANGE_ID")
    SourceExchange Exchange @relation("exchange-to-queue-source",fields: [SourceExchangeId], references: [Id],onDelete: Cascade)

    DestinationQueueId Int @map("FK_DESTINATION_QUEUE_ID")
    DestinationQueue Queue @relation("exchange-to-queue-destination",fields: [DestinationQueueId], references: [Id],onDelete: Cascade)

    RoutingKey String @map("TX_ROUTING_KEY") 
    Arguments Json @map("JS_ARGUMENTS")

    @@unique([SourceExchangeId, DestinationQueueId, VirtualHostId,RoutingKey],name: "UNIQUE_SOURCE_DESTINATION_VIRTUALHOST")
    @@map("TB_BINDING_EXCHANGE_TO_QUEUE")
}

model BindingExchangeToExchange {
    Id Int @id @default(autoincrement()) @map("ID")

    VirtualHostId Int @map("FK_VIRTUALHOST_ID")
    VirtualHost VirtualHost @relation(fields: [VirtualHostId], references: [Id],onDelete: Cascade)

    SourceExchangeId Int @map("FK_SOURCE_EXCHANGE_ID")
    SourceExchange Exchange @relation("exchange-source",fields: [SourceExchangeId], references: [Id],onDelete: Cascade)

    DestinationExchangeId Int @map("FK_DESTINATION_EXCHANGE_ID")
    DestinationExchange Exchange @relation("exchange-destionation",fields: [DestinationExchangeId], references: [Id],onDelete: Cascade)

    RoutingKey String @map("TX_ROUTING_KEY") 

    Arguments Json @map("JS_ARGUMENTS")

    @@unique([SourceExchangeId, DestinationExchangeId, VirtualHostId,RoutingKey],name: "UNIQUE_SOURCE_DESTINATION_VIRTUALHOST")
    @@map("TB_BINDING_EXCHANGE_TO_EXCHANGE")
}